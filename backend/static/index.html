<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Miner Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles */
        body {
            font-family: 'Inter', sans-serif;
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        /* Loading spinner */
        .spinner {
            border-top-color: #3498db;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-4 md:p-8">
        <header class="mb-8">
            <h1 class="text-4xl font-bold text-gray-800">Miner Monitor</h1>
            <p class="text-gray-600">Manage your local mining devices.</p>
        </header>

        <!-- Global Message Area -->
        <div id="global-message" class="hidden p-4 mb-4 text-sm rounded-lg" role="alert">
            <!-- Content dynamically added by JS -->
        </div>

        <!-- Miner Controls -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            
            <!-- Global Settings Column -->
            <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-semibold mb-4 text-gray-700">Global Miner Configuration</h2>
                <p class="text-sm text-gray-500 mb-4">
                    Current settings are loaded from the first available online device. 
                    New settings will be applied to <span id="online-device-count" class="font-bold">0</span> online devices.
                </p>
                <form id="global-config-form" class="space-y-4">
                    
                    <!-- Primary Stratum -->
                    <fieldset class="border border-gray-200 p-4 rounded-lg">
                        <legend class="text-lg font-medium text-gray-900 px-2">Primary Stratum</legend>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
                            <input type="text" id="stratumURL" placeholder="stratum.example.com" class="form-input">
                            <input type="number" id="stratumPort" placeholder="Port (e.g., 3333)" class="form-input">
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                            <input type="text" id="stratumUser" placeholder="Username / Wallet" class="form-input">
                            <input type="text" id="stratumPass" placeholder="Password (e.g., x)" class="form-input">
                        </div>
                        <div class="flex items-center mt-4 space-x-4">
                            <div class="flex items-center">
                                <input id="stratumExtranonceSubscribe" type="checkbox" class="form-checkbox" onchange="toggleDifficulty('stratum')">
                                <label for="stratumExtranonceSubscribe" class="ml-2 block text-sm text-gray-900">Extranonce Subscribe</label>
                            </div>
                            <div id="stratum-difficulty-container" class="hidden">
                                <input type="number" id="stratumSuggestedDifficulty" placeholder="Difficulty" class="form-input w-32">
                            </div>
                        </div>
                    </fieldset>

                    <!-- Fallback Stratum -->
                    <fieldset class="border border-gray-200 p-4 rounded-lg">
                        <legend class="text-lg font-medium text-gray-900 px-2">Fallback Stratum</legend>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
                            <input type="text" id="fallbackStratumURL" placeholder="fallback.example.com" class="form-input">
                            <input type="number" id="fallbackStratumPort" placeholder="Port (e.g., 3333)" class="form-input">
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                            <input type="text" id="fallbackStratumUser" placeholder="Username / Wallet" class="form-input">
                            <input type="text" id="fallbackStratumPass" placeholder="Password (e.g., x)" class="form-input">
                        </div>
                        <div class="flex items-center mt-4 space-x-4">
                            <div class="flex items-center">
                                <input id="fallbackStratumExtranonceSubscribe" type="checkbox" class="form-checkbox" onchange="toggleDifficulty('fallback')">
                                <label for="fallbackStratumExtranonceSubscribe" class="ml-2 block text-sm text-gray-900">Extranonce Subscribe</label>
                            </div>
                            <div id="fallback-difficulty-container" class="hidden">
                                <input type="number" id="fallbackStratumSuggestedDifficulty" placeholder="Difficulty" class="form-input w-32">
                            </div>
                        </div>
                    </fieldset>
                    
                    <button type="submit" id="update-all-btn" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-blue-700 transition duration-200">
                        Apply to All Online Devices
                    </button>
                </form>
            </div>

            <!-- Device Management Column -->
            <div class="space-y-6">
                <!-- Network Scan -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-700">Network Scan</h2>
                    <form id="scan-form" class="flex space-x-2">
                        <input type="text" id="subnet-input" placeholder="e.g., 192.168.1.1/24" class="form-input flex-grow">
                        <button type="submit" id="scan-btn" class="bg-indigo-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-indigo-700 transition duration-200">
                            Scan
                        </button>
                    </form>
                </div>
                
                <!-- Add Device -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-700">Add Device</h2>
                    <form id="add-device-form" class="flex space-x-2">
                        <input type="text" id="ip-input" placeholder="e.g., 192.168.1.100" class="form-input flex-grow">
                        <button type="submit" id="add-btn" class="bg-green-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-green-700 transition duration-200">
                            Add
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Device List -->
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
            <div class="p-6 flex justify-between items-center">
                <h2 class="text-2xl font-semibold text-gray-700">Device List</h2>
                <button id="refresh-devices-btn" class="bg-gray-200 text-gray-700 py-2 px-4 rounded-lg font-semibold hover:bg-gray-300 transition duration-200">
                    Refresh List
                </button>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hostname</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">IP Address</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stratum URL</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stratum User</th>
                            <th scope="col" class="relative px-6 py-3">
                                <span class="sr-only">Delete</span>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="device-list-body" class="bg-white divide-y divide-gray-200">
                        <!-- Devices will be populated here by JS -->
                        <tr>
                            <td colspan="6" class="px-6 py-12 text-center text-gray-500">
                                <div class="flex justify-center items-center">
                                    <div class="spinner w-8 h-8 border-4 border-gray-200 rounded-full"></div>
                                    <span class="ml-3">Loading devices...</span>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const API_URL = ''; // Use relative paths for API calls
        const deviceListBody = document.getElementById('device-list-body');
        const refreshButton = document.getElementById('refresh-devices-btn');
        const scanForm = document.getElementById('scan-form');
        const scanButton = document.getElementById('scan-btn');
        const addDeviceForm = document.getElementById('add-device-form');
        const addButton = document.getElementById('add-btn');
        const globalConfigForm = document.getElementById('global-config-form');
        const updateAllButton = document.getElementById('update-all-btn');
        const onlineDeviceCount = document.getElementById('online-device-count');
        const globalMessage = document.getElementById('global-message');

        // Form inputs
        const inputs = {
            stratumURL: document.getElementById('stratumURL'),
            stratumPort: document.getElementById('stratumPort'),
            stratumUser: document.getElementById('stratumUser'),
            stratumPass: document.getElementById('stratumPass'),
            stratumExtranonceSubscribe: document.getElementById('stratumExtranonceSubscribe'),
            stratumSuggestedDifficulty: document.getElementById('stratumSuggestedDifficulty'),
            
            fallbackStratumURL: document.getElementById('fallbackStratumURL'),
            fallbackStratumPort: document.getElementById('fallbackStratumPort'),
            fallbackStratumUser: document.getElementById('fallbackStratumUser'),
            fallbackStratumPass: document.getElementById('fallbackStratumPass'),
            fallbackStratumExtranonceSubscribe: document.getElementById('fallbackStratumExtranonceSubscribe'),
            fallbackStratumSuggestedDifficulty: document.getElementById('fallbackStratumSuggestedDifficulty')
        };
        const stratumDifficultyContainer = document.getElementById('stratum-difficulty-container');
        const fallbackDifficultyContainer = document.getElementById('fallback-difficulty-container');

        /**
         * Shows or hides the difficulty input based on the checkbox.
         */
        function toggleDifficulty(type) {
            const checkbox = (type === 'stratum') ? inputs.stratumExtranonceSubscribe : inputs.fallbackStratumExtranonceSubscribe;
            const container = (type === 'stratum') ? stratumDifficultyContainer : fallbackDifficultyContainer;
            
            if (checkbox.checked) {
                container.classList.remove('hidden');
            } else {
                container.classList.add('hidden');
            }
        }

        /**
         * Displays a global message.
         * @param {string} message - The message to display.
         * @param {string} type - 'success', 'error', or 'info'.
         */
        function showMessage(message, type = 'info') {
            globalMessage.textContent = message;
            globalMessage.classList.remove('hidden', 'bg-green-100', 'text-green-700', 'bg-red-100', 'text-red-700', 'bg-blue-100', 'text-blue-700');
            
            if (type === 'success') {
                globalMessage.classList.add('bg-green-100', 'text-green-700');
            } else if (type === 'error') {
                globalMessage.classList.add('bg-red-100', 'text-red-700');
            } else {
                globalMessage.classList.add('bg-blue-100', 'text-blue-700');
            }
            
            setTimeout(() => {
                globalMessage.classList.add('hidden');
            }, 5000);
        }

        /**
         * Renders the list of devices in the table.
         * @param {Array} devices - An array of device objects.
         */
        function renderDeviceList(devices) {
            deviceListBody.innerHTML = ''; // Clear existing list
            
            if (!devices || devices.length === 0) {
                deviceListBody.innerHTML = `<tr><td colspan="6" class="px-6 py-12 text-center text-gray-500">No devices found. Add a device or scan the network.</td></tr>`;
                onlineDeviceCount.textContent = '0';
                return;
            }

            const onlineDevices = devices.filter(d => d.online);
            onlineDeviceCount.textContent = onlineDevices.length;

            if (onlineDevices.length > 0) {
                // Use the first online device to populate the global settings form
                updateGlobalSettingsUI(onlineDevices[0].settings);
            }

            devices.forEach(device => {
                const row = document.createElement('tr');
                row.className = device.online ? 'bg-white' : 'bg-gray-50 opacity-60';

                let status = device.online ?
                    `<span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Online</span>` :
                    `<span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">Offline</span>`;

                // Get settings, provide 'N/A' for offline devices or missing settings
                let stratumURL = 'N/A';
                let stratumUser = 'N/A';
                
                if (device.online && device.settings) {
                    stratumURL = device.settings.stratumURL || 'N/A';
                    stratumUser = device.settings.stratumUser || 'N/A';
                }

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${device.hostname}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <a href="http://${device.ip}" target="_blank" class="text-indigo-600 hover:text-indigo-900">${device.ip}</a>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">${status}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 max-w-xs truncate" title="${stratumURL}">
                        ${stratumURL}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 max-w-xs truncate" title="${stratumUser}">
                        ${stratumUser}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="handleDelete('${device.ip}')" class="text-red-600 hover:text-red-900">Delete</button>
                    </td>
                `;
                deviceListBody.appendChild(row);
            });
        }

        /**
         * Updates the global settings form with data from a device.
         * @param {object} settings - The settings object from a device.
         */
        function updateGlobalSettingsUI(settings) {
            if (!settings) return;

            for (const key in inputs) {
                if (settings[key] !== undefined) {
                    if (inputs[key].type === 'checkbox') {
                        inputs[key].checked = !!settings[key];
                    } else {
                        inputs[key].value = settings[key];
                    }
                }
            }
            // Manually trigger toggles
            toggleDifficulty('stratum');
            toggleDifficulty('fallback');
        }

        /**
         * Fetches the list of all devices from the backend.
         */
        async function fetchDevices() {
            setLoading(refreshButton, true);
            try {
                const response = await fetch(`${API_URL}/api/devices`);
                if (!response.ok) throw new Error('Failed to fetch devices');
                const devices = await response.json();
                renderDeviceList(devices);
            } catch (error) {
                console.error('Error fetching devices:', error);
                showMessage(error.message, 'error');
            } finally {
                setLoading(refreshButton, false);
            }
        }

        /**
         * Handles the submission of the "Add Device" form.
         */
        async function handleAddDevice(event) {
            event.preventDefault();
            const ipInput = document.getElementById('ip-input');
            const ip = ipInput.value.trim();
            if (!ip) return;

            setLoading(addButton, true);
            try {
                const response = await fetch(`${API_URL}/api/devices`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ip })
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.error || 'Failed to add device');
                
                showMessage(`Device ${result.hostname} (${result.ip}) added successfully.`, 'success');
                ipInput.value = '';
                fetchDevices(); // Refresh the list
            } catch (error) {
                console.error('Error adding device:', error);
                showMessage(error.message, 'error');
            } finally {
                setLoading(addButton, false);
            }
        }

        /**
         * Handles the "Delete" button click for a device.
         * @param {string} ip - The IP address of the device to delete.
         */
        async function handleDelete(ip) {
            // Replaced confirm() with a less intrusive prompt, but standard confirm is fine for this internal tool.
            // Let's use the original confirm().
            if (!confirm(`Are you sure you want to delete device ${ip}?`)) return;

            try {
                const response = await fetch(`${API_URL}/api/devices/${ip}`, { method: 'DELETE' });
                const result = await response.json();
                if (!response.ok) throw new Error(result.error || 'Failed to delete device');
                
                showMessage(`Device ${ip} deleted.`, 'success');
                fetchDevices(); // Refresh the list
            } catch (error) {
                console.error('Error deleting device:', error);
                showMessage(error.message, 'error');
            }
        }

        /**
         * Handles the submission of the "Scan Network" form.
         */
        async function handleScan(event) {
            event.preventDefault();
            const subnetInput = document.getElementById('subnet-input');
            const subnet = subnetInput.value.trim();
            if (!subnet) return;

            setLoading(scanButton, true);
            showMessage(`Scanning subnet ${subnet}... This may take a moment.`, 'info');
            try {
                const response = await fetch(`${API_URL}/api/scan`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ subnet })
                });
                const results = await response.json();
                if (!response.ok) throw new Error(results.error || 'Failed to scan network');
                
                showMessage(`Scan complete. Found ${results.length} new devices.`, 'success');
                fetchDevices(); // Refresh the full list
            } catch (error) {
                console.error('Error scanning network:', error);
                showMessage(error.message, 'error');
            } finally {
                setLoading(scanButton, false);
            }
        }

        /**
         * Handles the submission of the "Global Config" form.
         */
        async function handleUpdateAll(event) {
            event.preventDefault();
            
            const payload = {};

            // String fields (send even if empty to clear them)
            payload.stratumURL = inputs.stratumURL.value;
            payload.stratumUser = inputs.stratumUser.value;
            payload.stratumPass = inputs.stratumPass.value;
            payload.fallbackStratumURL = inputs.fallbackStratumURL.value;
            payload.fallbackStratumUser = inputs.fallbackStratumUser.value;
            payload.fallbackStratumPass = inputs.fallbackStratumPass.value;

            // Number fields (only send if a valid number is entered)
            const stratumPort = parseInt(inputs.stratumPort.value, 10);
            if (!isNaN(stratumPort)) payload.stratumPort = stratumPort;
            
            const fallbackStratumPort = parseInt(inputs.fallbackStratumPort.value, 10);
            if (!isNaN(fallbackStratumPort)) payload.fallbackStratumPort = fallbackStratumPort;

            // Checkbox fields
            payload.stratumExtranonceSubscribe = inputs.stratumExtranonceSubscribe.checked ? 1 : 0;
            payload.fallbackStratumExtranonceSubscribe = inputs.fallbackStratumExtranonceSubscribe.checked ? 1 : 0;

            // Conditional difficulty fields
            if (payload.stratumExtranonceSubscribe) {
                const stratumDiff = parseInt(inputs.stratumSuggestedDifficulty.value, 10);
                payload.stratumSuggestedDifficulty = isNaN(stratumDiff) ? 0 : stratumDiff;
            }
            if (payload.fallbackStratumExtranonceSubscribe) {
                const fallbackDiff = parseInt(inputs.fallbackStratumSuggestedDifficulty.value, 10);
                payload.fallbackStratumSuggestedDifficulty = isNaN(fallbackDiff) ? 0 : fallbackDiff;
            }

            setLoading(updateAllButton, true);
            showMessage('Sending update to all online devices...', 'info');
            try {
                const response = await fetch(`${API_URL}/api/devices/update`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const results = await response.json();
                if (!response.ok) throw new Error(results.error || 'Failed to send updates');

                const successCount = results.filter(r => r.success).length;
                const failCount = results.length - successCount;
                
                showMessage(`Update complete. ${successCount} devices updated successfully, ${failCount} failed.`, 'success');
                fetchDevices(); // Refresh list to show new settings
            } catch (error) {
                console.error('Error updating devices:', error);
                showMessage(error.message, 'error');
            } finally {
                setLoading(updateAllButton, false);
            }
        }

        /**
         * Sets the loading state for a button.
         * @param {HTMLElement} button - The button element.
         * @param {boolean} isLoading - Whether to show the loading state.
         */
        function setLoading(button, isLoading) {
            if (isLoading) {
                button.disabled = true;
                button.classList.add('opacity-50', 'cursor-not-allowed');
                // You could add a spinner icon here if you want
            } else {
                button.disabled = false;
                button.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        // --- Initial Load and Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            fetchDevices();
            
            refreshButton.addEventListener('click', fetchDevices);
            scanForm.addEventListener('submit', handleScan);
            addDeviceForm.addEventListener('submit', handleAddDevice);
            globalConfigForm.addEventListener('submit', handleUpdateAll);

            // Add common styles to form inputs
            document.querySelectorAll('.form-input').forEach(el => {
                el.classList.add('block', 'w-full', 'px-3', 'py-2', 'border', 'border-gray-300', 'rounded-md', 'shadow-sm', 'focus:outline-none', 'focus:ring-indigo-500', 'focus:border-indigo-500', 'sm:text-sm');
            });
            document.querySelectorAll('.form-checkbox').forEach(el => {
                el.classList.add('h-4', 'w-4', 'text-indigo-600', 'border-gray-300', 'rounded', 'focus:ring-indigo-500');
            });
        });
    </script>
</body>
</html>

